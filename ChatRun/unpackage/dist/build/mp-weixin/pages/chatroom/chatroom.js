(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chatroom/chatroom"],{5199:function(e,t,i){"use strict";(function(e){i("1a46");s(i("66fd"));var t=s(i("c65b"));function s(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=i,e(t.default)}).call(this,i("543d")["createPage"])},"5d61":function(e,t,i){"use strict";var s=i("e34d"),n=i.n(s);n.a},"94df":function(e,t,i){"use strict";i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return s}));var s={submit:function(){return i.e("components/submit/submit").then(i.bind(null,"98bd"))}},n=function(){var e=this,t=e.$createElement,i=(e._self._c,e.__map(e.msgs,(function(t,i){var s=e.__get_orig(t),n=""!==t.time?e.changeTime(t.time):null,a=t.fromId!==e.uid&&3==t.types?e.covers(t.message):null,o=t.fromId===e.uid&&3==t.types?e.covers(t.message):null;return{$orig:s,m0:n,m1:a,m2:o}})));e.$mp.data=Object.assign({},{$root:{l0:i}})},a=[]},"9eb4":function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;n(i("e652"));var s=n(i("ec9e"));function n(e){return e&&e.__esModule?e:{default:e}}var a={data:function(){return{msgs:[],msgImgArr:[],oldTime:0,scrollToView:"",inputh:"60",isPlay:!1,animationData1:{},animation:{},loading:"",isloading:!0,scrollAnimation:!0,beginLoading:!0,uid:"",uimgurl:"",token:"",uname:"",fid:"",fname:"",type:"",fimgurl:"",pageSize:10,nowPage:0}},components:{submit:function(){i.e("components/submit/submit").then(function(){return resolve(i("98bd"))}.bind(null,i)).catch(i.oe)}},onLoad:function(e){this.fid=e.id,this.fname=e.name,this.type=e.type,this.fimgurl=e.img,this.getStorages(),this.getMsg(),this.receiveSocketMsg()},methods:{getStorages:function(){try{var t=e.getStorageSync("user");t?(this.uid=t.id,this.uimgurl=this.serverUrl+"/"+t.imgurl,this.token=t.token,this.uname=t.name):e.navigateTo({url:"../signin/signin"})}catch(i){}},getMsg:function(){var t=this;e.request({url:this.serverUrl+"/chat/msg",data:{uid:this.uid,fid:this.fid,nowPage:this.nowPage,pageSize:this.pageSize,token:this.token},method:"POST",success:function(i){var n=i.data.status;if(200===n){var a=i.data.result;if(a.reverse(),console.log(a),a.length>0){var o=a[0].time;a[0].imgurl=t.serverUrl+a[0].imgurl;for(var r=1;r<a.length;r++){var u=a[r];if(r<a.length-1){var m=s.default.spacTime(o,u.time);m&&(o=m),u.time=m}0===t.nowPage&&u.time>t.oldTime&&(t.oldTime=u.time),1===u.types&&(u.message=t.serverUrl+u.imgurl,t.msgImgArr.unshift(u.message)),3===u.types&&(u.message=JSON.parse(u.message)),u.imgurl=t.serverUrl+u.imgurl}t.msgs=a.concat(t.msgs),t.msgImgArr=[].concat(t.msgImgArr)}10===a.length?t.nowPage++:t.nowPage=-1,t.$nextTick((function(){this.scrollAnimation=!1,this.scrollToView="msg"+this.msgs[a.length-1].id})),clearInterval(t.loading),t.loading=!0,t.beginLoading=!0}else 500===n?e.showToast({title:"服务器出错了...",icon:"none",duration:1500}):300===n&&e.navigateTo({url:"/pages/signin/signin?name="+t.myname})}})},nextPage:function(){if(this.nowPage>0&&this.beginLoading){this.loading=!1,this.beginLoading=!1;var t=e.createAnimation({duration:1e3,timingFunction:"ease"});this.animation=t,this.animationData1=t.export();var i=1;this.loading=setInterval(function(){t.rotate(20*i).step(),this.animationData1=t.export(),i++,this.getMsg(this.nowPage)}.bind(this),60)}},covers:function(e){return[{latitude:e.latitude,longitude:e.longitude,iconPath:"../../static/images/pos.png"}]},openLocation:function(t){e.openLocation({latitude:t.latitude,longitude:t.longitude,name:t.name,address:t.address,success:function(){console.log("success")}})},changeTime:function(e){return s.default.dataTime1(e)},previewImg:function(t){var i=this,s=0;this.msgImgArr.map((function(e,n){i.msgImgArr[n]===t&&(s=n)})),e.previewImage({current:s,urls:this.msgImgArr,longPressActions:{itemList:["发送给朋友","保存图片","收藏"],success:function(e){},fail:function(e){}}})},inputs:function(e){this.receiveMsg(e,this.uid,this.uimgurl,0),this.ToBottom()},receiveMsg:function(t,i,n,a){var o=this;if(0!==t.types&&3!==t.types||this.sendSocket(t),1===t.types){this.msgImgArr.push(t.msg);var r=s.default.fileName(new Date);e.uploadFile({url:this.serverUrl+"/files/upload",filePath:t.msg,name:"file",formData:{url:r,name:(new Date).getTime()+this.uid+Math.ceil(10*Math.random())},success:function(e){var i={message:e.data,types:t.types};o.sendSocket(i)}})}if(2===t.types){var u=s.default.fileName(new Date);e.uploadFile({url:this.serverUrl+"/files/upload",filePath:t.msg.voice,name:"file",formData:{url:u,name:(new Date).getTime()+this.uid+Math.ceil(10*Math.random())},success:function(e){var i={message:e.data,types:t.types};o.sendSocket(i)}})}this.scrollAnimation=!0;var m=new Date,l=s.default.spacTime(this.oldTime,m);l&&(this.oldTime=l),m=l,3==t.types&&(t.msg=JSON.parse(t.msg));var g={fromId:i,types:t.types,imgurl:n,id:this.msgs.length,time:m,message:t.msg};this.msgs.push(g)},sendSocket:function(e){0==this.type?this.socket.emit("msg",e,this.uid,this.fid):this.socket.emit("groupMsg",e,this.uid,this.fid)},receiveSocketMsg:function(){var e=this;this.socket.on("msg",(function(t,i,n){if(i==e.fid&&0==n){e.scrollAnimation=!0;var a,o=new Date,r=s.default.spacTime(e.oldTime,o);r&&(e.oldTime=r),o=r,a={fromId:i,types:t.types,imgurl:e.fimgurl,id:e.msgs.length,time:o,message:t.msg},1!=t.types&&2!=t.types||(a={fromId:i,types:t.types,imgurl:e.fimgurl,id:e.msgs.length,time:o,message:t.message},1==t.types&&(console.log(t),e.msgImgArr.push(t.message))),e.msgs.push(a),e.ToBottom()}}))},playVoice:function(t){var i=e.createInnerAudioContext();i.autoplay=!0,i.src=t,i.onPlay((function(){}))},heights:function(e){this.inputh=e,this.ToBottom()},ToBottom:function(){this.scrollAnimation=!0,this.scrollToView="",this.$nextTick((function(){this.scrollToView="msg"+this.msgs[this.msgs.length-1].id}))},backOnePage:function(){e.navigateBack({delta:1})}}};t.default=a}).call(this,i("543d")["default"])},c65b:function(e,t,i){"use strict";i.r(t);var s=i("94df"),n=i("ea6c");for(var a in n)["default"].indexOf(a)<0&&function(e){i.d(t,e,(function(){return n[e]}))}(a);i("5d61");var o=i("f0c5"),r=Object(o["a"])(n["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],void 0);t["default"]=r.exports},e34d:function(e,t,i){},ea6c:function(e,t,i){"use strict";i.r(t);var s=i("9eb4"),n=i.n(s);for(var a in s)["default"].indexOf(a)<0&&function(e){i.d(t,e,(function(){return s[e]}))}(a);t["default"]=n.a}},[["5199","common/runtime","common/vendor"]]]);